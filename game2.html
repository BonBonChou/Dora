<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°éŠæˆ²2</title>
  <style>
    body {
      margin: 0;
      background: transparent;
      font-family: 'Noto Sans TC', sans-serif;
      color: white;
      text-align: center;
    }

    .stars {
      position: fixed;
      width: 100%;
      height: 100%;
      background: url('https://raw.githubusercontent.com/BonBonChou/Dora/main/images/stars.jpeg') repeat-y center / cover;
      animation: scrollStars 60s linear infinite;
      z-index: 0;
      opacity: 0.8;
    }

    @keyframes scrollStars {
      from { background-position: 0 0; }
      to   { background-position: 0 1000px; }
    }

    .hidden {
      display: none;
    }

    button {
      margin: 1em;
      padding: 0.75em 2em;
      font-size: 1.2em;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #1e90ff;
      color: white;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #63b3ed;
    }

    .container {
      position: relative;
      z-index: 1;
      padding: 10vh 2em 2em;
      max-width: 650px;
      margin: auto;
    }

    h1 {
      font-size: 2.4em;
      margin: 0.2em 0;
    }

    h4 {
      font-size: 1.6em;
      color: #00ffcc;
      margin: 0 0 1em;
    }

    #game-area {
      position: relative;
      width: 100%;
      height: 80vh;
      overflow: hidden;
      cursor: pointer;
      z-index: 1;
    }

    .hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2em;
      font-size: 2.2em;
      z-index: 3;
    }

    .hud div {
      white-space: nowrap;
    }

    .ship {
      position: absolute;
      width: 80px;
      height: 80px;
      bottom: 10%;
      left: 25%;
      transform: translateX(-50%);
      transition: left 0.15s;
      z-index: 2;
    }

    .ship img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .bullet {
      position: absolute;
      width: 6px;
      height: 30px;
      background: #29dfff;
      pointer-events: none;
    }

    .item {
      position: absolute;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .m1  { background: #444; }
    .m5  { background: #555; }
    .m10 { background: #666; }
    .big {
      width: 160px;
      height: 160px;
      background: #784b1e;
    }

    .power {
      width: 60px;
      height: 60px;
      position: absolute;
      pointer-events: none;
    }

    @keyframes explode {
      to {
        transform: scale(1.5);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <!-- æ•™å­¸ -->
  <div id="tut" class="container">
    <h1>æ¸…é™¤éšœç¤™ç‰©</h1>
    <h4>å³å°‡é€²å…¥å°è¡Œæ˜Ÿå¸¶ï¼Œè«‹æ¸…é™¤çœ¼å‰éšœç¤™ç‰©ï¼</h4>
    <div class="intro">
      <p>æ‹–æ›³ï¼é»æ“Šç§»å‹•é£›èˆ¹ï¼Œè‡ªå‹•å°„æ“Šç²‰ç¢éš•çŸ³ï¼</p>
      <p>ğŸ›¢ï¸ æ“Šç¢ä¸åŒéš•çŸ³å¢åŠ ä¸åŒç‡ƒæ–™ï¼ˆ+1 / +5 / +10 / +100ï¼‰</p>
      <p>ğŸ’¥ ç¢°åˆ°éš•çŸ³å³å¤±æ•—</p>
      <p>ğŸ”° éš¨æ©Ÿæ‰è½å¢ç›Šï¼š</p>
      <p>ğŸ”« é€£ç™¼ã€æ­£å‘å¤šç™¼ã€æ–œå‘å¤šç™¼</p>
    </div>
    <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="game" class="hidden">
    <div class="hud">
      <div>ç‡ƒæ–™ï¼š<span id="fuel-num">0</span></div>
    </div>
    <div id="game-area">
      <div id="ship" class="ship">
        <img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.png">
      </div>
    </div>
  </div>

  <!-- æˆåŠŸ -->
  <div id="success" class="container hidden">
    <h1>ä»»å‹™é”æˆï¼</h1>
    <h4>ç¸½ç‡ƒæ–™ <span id="fuel-final"></span></h4>
    <button onclick="location.href='intro2.html'">ä¸‹ä¸€ç«™</button>
  </div>

  <!-- å¤±æ•— -->
  <div id="fail" class="container hidden">
    <h1>è¢«éš•çŸ³æ’æ¯€ï¼</h1>
    <button onclick="restartGame()">å†æŒ‘æˆ°</button>
  </div>

  <script>
    /* ----- å¸¸æ•¸èˆ‡ç‹€æ…‹ ----------------------------------------------------- */
    const area   = document.getElementById('game-area');
    const shipEl = document.getElementById('ship');
    const fuelHUD= document.getElementById('fuel-num');
    let fuel     = parseInt(localStorage.getItem('fuel')||'0');
    let playing  = false;

    /* ç§»å‹•æ§åˆ¶ */
    area.addEventListener('pointerdown',  e=>moveShip(e));
    area.addEventListener('pointermove',  e=>playing && moveShip(e));

    function moveShip(e){
      const rect = area.getBoundingClientRect();
      let x = (e.clientX - rect.left)/rect.width;   // 0~1
      shipEl.style.left = (x*100)+'%';
    }

    /* ----- å­å½ˆç³»çµ± ------------------------------------------------------- */
    let fireInterval=400;           // åŸºç¤å°„é€Ÿ (ms)
    let fireTimer;
    let multiForward=0;             // 0 æˆ– 1 (å‰æ–¹åŠ ä¸€å½ˆ)
    let multiDiagonal=0;            // 0~2  (Â±æ–œå½ˆå°æ•¸)
    let bullets=[];

    /* ç”Ÿæˆå­å½ˆ */
    function shoot(){
      spawnBullet(0, -12);               // ä¸»å½ˆ
      if(multiForward) spawnBullet(0, -12, -20); // å‰æ–¹+1
      if(multiDiagonal){
        for(let i=1;i<=multiDiagonal;i++){
          spawnBullet(-6*i, -12);        // å·¦æ–œ
          spawnBullet( 6*i, -12);        // å³æ–œ
        }
      }
    }

    function spawnBullet(offsetX, vy, extraY=0){
      const b=document.createElement('div');
      b.className='bullet';
      const shipRect=shipEl.getBoundingClientRect();
      b.style.left=(shipEl.offsetLeft + shipEl.offsetWidth/2 + offsetX)+'px';
      b.style.top =(shipEl.offsetTop + extraY)+'px';
      area.appendChild(b);
      bullets.push({el:b, vy});
    }

    /* ----- éš•çŸ³èˆ‡é“å…· ----------------------------------------------------- */
    let items=[];      // å°éš•çŸ³ / å¤§éš•çŸ³ / é“å…·
    let spawnDelay=900;
    let spawnTimer;
    let bigMeteorSpawned=false;
    const smallTypes=[
      {cls:'m1', val:1 , img:'https://raw.githubusercontent.com/BonBonChou/Dora/main/images/meteor1.png'},
      {cls:'m5', val:5 , img:'https://raw.githubusercontent.com/BonBonChou/Dora/main/images/meteor5.png'},
      {cls:'m10',val:10, img:'https://raw.githubusercontent.com/BonBonChou/Dora/main/images/meteor10.png'}
    ];

    /* æ‰è½å¢ç›Šåœ–ç‰‡ (è«‹æ›¿æ›ç‚ºè‡ªå·±çš„) */
    const powerImgs={
      rapid  :'https://raw.githubusercontent.com/BonBonChou/Dora/main/images/rapid.png',
      forward:'https://raw.githubusercontent.com/BonBonChou/Dora/main/images/forward.png',
      diag   :'https://raw.githubusercontent.com/BonBonChou/Dora/main/images/diag.png'
    };

    function spawnSmall(){
      const type = smallTypes[Math.floor(Math.random()*smallTypes.length)];
      const div = document.createElement('div');
      div.className=`item ${type.cls}`;
      div.dataset.type='small';
      div.dataset.val =type.val;
      div.innerHTML   =`<img src="${type.img}">`;
      randomSpawn(div, 2+Math.random()*2);
    }

    function spawnBig(){
      const div=document.createElement('div');
      div.className='item big';
      div.dataset.type='big';
      div.dataset.hp=25;                   // éœ€ 25 ç™¼å­å½ˆ
      div.innerHTML=`<img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/bigmeteor.png">`; // TODO
      randomSpawn(div,1.5);
    }

    function spawnPower(x,y){
      const chance=Math.random();
      let kind='';
      if(chance<0.33) kind='rapid';
      else if(chance<0.66) kind='forward';
      else kind='diag';
      const p=document.createElement('div');
      p.className='power';
      p.dataset.type='power';
      p.dataset.kind=kind;
      p.innerHTML=`<img src="${powerImgs[kind]}" style="width:100%;height:100%">`;
      p.style.left=x+'px';
      p.style.top =y+'px';
      area.appendChild(p);
      items.push({el:p, vy:2});
    }

    function randomSpawn(el, vy){
      el.style.left=Math.random()*(area.offsetWidth-80)+'px';
      el.style.top ='-100px';
      area.appendChild(el);
      items.push({el, vy});
    }

    /* ----- ä¸»éŠæˆ²è¿´åœˆ ----------------------------------------------------- */
    let animId;
    function loop(){
      // æ›´æ–°å­å½ˆ
      bullets.forEach(b=>{
        b.el.style.top = (b.el.offsetTop - 10)+'px';
      });
      bullets = bullets.filter(b=>{
        if(b.el.offsetTop<-40){b.el.remove();return false;}
        return true;
      });

      // æ›´æ–°æ‰è½ç‰©
      items.forEach(obj=>{
        obj.el.style.top=(obj.el.offsetTop+obj.vy)+'px';

        /* æ’¿é“å…·åˆ¤å®š */
        if(obj.el.dataset.type==='power' && hitTest(obj.el,shipEl)){
          applyPower(obj.el.dataset.kind);
          obj.el.remove(); obj.vy=0;
        }

        /* èˆ¹æ’éš•çŸ³åˆ¤å®š */
        if((obj.el.dataset.type==='small' || obj.el.dataset.type==='big') && hitTest(obj.el,shipEl)){
          endFail(); return;
        }

        /* å­å½ˆæ’éš•çŸ³ */
        bullets.forEach(b=>{
          if(hitTest(b.el,obj.el)){
            if(obj.el.dataset.type==='small'){
              fuel+=parseInt(obj.el.dataset.val);
              fuelHUD.textContent=fuel;
              // é“å…·æ‰è½ 20% æ©Ÿç‡
              if(Math.random()<0.2) spawnPower(obj.el.offsetLeft,obj.el.offsetTop);
              obj.el.style.animation='explode .3s forwards';
              setTimeout(()=>obj.el.remove(),300);
              obj.vy=9999; // ç«‹å³ç§»é™¤æ§åˆ¶
            }else if(obj.el.dataset.type==='big'){
              let hp=--obj.el.dataset.hp;
              if(hp<=0){
                fuel+=100;
                fuelHUD.textContent=fuel;
                obj.el.style.animation='explode .5s forwards';
                setTimeout(()=>victory(),500);
              }
            }
            // æ¸…å½ˆ
            b.el.remove(); b.vy=0;
          }
        });
      });

      // ç§»é™¤å‡ºç•«é¢
      items = items.filter(o=>{
        if(o.vy===0) return false;
        if(o.el.offsetTop>area.offsetHeight+120){o.el.remove();return false;}
        return true;
      });

      if(playing) animId=requestAnimationFrame(loop);
    }

    /* ----- åˆ¤å®š &é“å…·æ•ˆæœ -------------------------------------------------- */
    function hitTest(a,b){
      const ar=a.getBoundingClientRect(), br=b.getBoundingClientRect();
      return !(
        ar.right < br.left ||
        ar.left  > br.right||
        ar.bottom< br.top  ||
        ar.top   > br.bottom
      );
    }

    function applyPower(kind){
      if(kind==='rapid'){
        fireInterval=Math.max(100,fireInterval-80);
        clearInterval(fireTimer);
        fireTimer=setInterval(shoot,fireInterval);
      }else if(kind==='forward'){
        multiForward=1;
      }else if(kind==='diag'){
        multiDiagonal=Math.min(2,multiDiagonal+1);
      }
    }

    /* ----- æµç¨‹æ§åˆ¶ -------------------------------------------------------- */
    function startGame(){
      document.getElementById('tut').classList.add('hidden');
      document.getElementById('game').classList.remove('hidden');
      playing=true;
      fuelHUD.textContent=fuel;
      /* åˆå§‹åŒ–å°„æ“Š */
      fireTimer=setInterval(shoot,fireInterval);
      /* å°éš•çŸ³ç”Ÿæˆ */
      spawnTimer=setInterval(()=>{
        if(!bigMeteorSpawned){
          spawnSmall();
          spawnDelay=Math.max(200,spawnDelay-15); // ç”Ÿæˆé–“éš”è¶Šä¾†è¶ŠçŸ­
        }
      },spawnDelay);
      /* ä¸» loop */
      animId=requestAnimationFrame(loop);
    }

    function checkBigMeteor(){
      if(fuel>=500 && !bigMeteorSpawned){
        bigMeteorSpawned=true;
        clearInterval(spawnTimer);
        spawnBig();
      }
    }

    function victory(){
      playing=false;
      clearInterval(spawnTimer);clearInterval(fireTimer);cancelAnimationFrame(animId);
      localStorage.setItem('fuel',fuel);
      document.getElementById('game').classList.add('hidden');
      document.getElementById('fuel-final').textContent=fuel;
      document.getElementById('success').classList.remove('hidden');
    }

    function endFail(){
      playing=false;
      clearInterval(spawnTimer);clearInterval(fireTimer);cancelAnimationFrame(animId);
      document.getElementById('game').classList.add('hidden');
      document.getElementById('fail').classList.remove('hidden');
    }

    function restartGame(){
      // éš±è—å¤±æ•—ç•«é¢ï¼Œé¡¯ç¤ºæ•™å­¸é 
      document.getElementById('fail').classList.add('hidden');
      document.getElementById('tut').classList.remove('hidden');
      document.getElementById('success').classList.add('hidden');
      document.getElementById('game').classList.add('hidden');

      // åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨èˆ‡å‹•ç•«
      clearInterval(fireTimer);
      clearInterval(spawnTimer);
      cancelAnimationFrame(animId);

      // é‡è¨­ç‹€æ…‹è®Šæ•¸
      fuel = parseInt(localStorage.getItem('fuel') || '0');
      fireInterval = 400;
      multiForward = 0;
      multiDiagonal = 0;
      spawnDelay = 900;
      bigMeteorSpawned = false;
      bullets = [];
      items = [];

      // æ¸…é™¤ç•«é¢å…ƒç´ 
      const area = document.getElementById('game-area');
      area.innerHTML = `
        <div id="ship" class="ship">
          <img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.png">
        </div>
      `;

      // é‡è¨­é£›èˆ¹ DOM èˆ‡äº‹ä»¶ï¼ˆå¦‚ä½ å¸Œæœ›å¯æ‹–ç§»ï¼‰
      const shipEl = document.getElementById('ship');
      shipEl.style.left = '25%';
    }

    /* ç›£çœ‹ fuel é” 500 æ™‚è§¸ç™¼å¤§éš•çŸ³ */
    setInterval(checkBigMeteor,500);
  </script>
</body>
</html>
