<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°éŠæˆ²2</title>
  <style>
    body {
      margin: 0;
      background: transparent;
      font-family: 'Noto Sans TC', sans-serif;
      color: white;
      text-align: center;
    }

    .stars {
      position: fixed;
      width: 100%;
      height: 100%;
      background: url('https://raw.githubusercontent.com/BonBonChou/Dora/main/images/stars.jpeg') repeat-y center / cover;
      animation: scrollStars 60s linear infinite;
      z-index: 0;
      opacity: 0.8;
    }

    @keyframes scrollStars {
      from { background-position: 0 0; }
      to   { background-position: 0 1000px; }
    }

    .hidden {
      display: none;
    }

    button {
      margin: 1em;
      padding: 0.75em 2em;
      font-size: 1.2em;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #1e90ff;
      color: white;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #63b3ed;
    }

    .container {
      position: relative;
      z-index: 1;
      padding: 10vh 2em 2em;
      max-width: 650px;
      margin: auto;
    }

    h1 {
      font-size: 2.4em;
      margin: 0.2em 0;
    }

    h4 {
      font-size: 1.6em;
      color: #00ffcc;
      margin: 0 0 1em;
    }

    .intro {
      text-align: justify;
      background: rgba(255,255,255,0.05);
      padding: 1em;
      width: fit-content;     /* æ ¸å¿ƒï¼šè‡ªå‹•æ ¹æ“šå…§å®¹å¯¬åº¦èª¿æ•´ */
      max-width: 100%;        /* é˜²æ­¢å¤ªé•·æ™‚è¶…å‡ºç•«é¢ */
      border-radius: 10px;
      margin: 0 auto 1.5em auto;  /* æ°´å¹³ç½®ä¸­ */
      margin-bottom: 1.5em;
      font-size: 1em;
    }

    #game-area {
      position: relative;
      width: 100%;
      height: 80vh;
      overflow: hidden;
      cursor: pointer;
      z-index: 1;
    }

    .hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2em;
      font-size: 2.2em;
      z-index: 3;
    }

    .hud div {
      white-space: nowrap;
    }

    .ship {
      position: absolute;
      width: 80px;
      height: 80px;
      bottom: 10%;
      left: 25%;
      transform: translateX(-50%);
      transition: left 0.15s;
      z-index: 2;
    }

    .ship img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .bullet {
      position: absolute;
      width: 6px;
      height: 30px;
      background: #29dfff;
      pointer-events: none;
    }

    .item {
      position: absolute;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .m1  { background: #444; }
    .m5  { background: #555; }
    .m10 { background: #666; }
    .big {
      width: 160px;
      height: 160px;
      background: #784b1e;
    }

    .power {
      width: 60px;
      height: 60px;
      position: absolute;
      pointer-events: none;
    }

    @keyframes explode {
      to {
        transform: scale(1.5);
        opacity: 0;
      }
    }

    .fuel-status {
      font-weight: bold;
      color: #00ccff;
      margin-top: 0.5em;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <!-- æ•™å­¸ -->
  <div id="tut" class="container">
    <h1>æ¸…é™¤éšœç¤™ç‰©</h1>
    <h4>é€²å…¥å°è¡Œæ˜Ÿå¸¶ï¼Œæ¸…é™¤éšœç¤™ç‰©ï¼</h4>
    <p id="fuel" class="fuel-status"></p>
    <div class="intro">
      <p>æ‹–æ›³ï¼é»æ“Šç§»å‹•é£›èˆ¹ï¼Œè‡ªå‹•å°„æ“Šç²‰ç¢éš•çŸ³ï¼</p>
      <p>ğŸ›¢ï¸ æ“Šç¢ä¸åŒéš•çŸ³å¢åŠ ä¸åŒç‡ƒæ–™ï¼ˆ+1 / +5 / +10 / +100ï¼‰</p>
      <p>ğŸ’¥ ç¢°åˆ°éš•çŸ³å³å¤±æ•—</p>
    </div>
    <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="game" class="hidden">
    <div class="hud">
      <div>ç‡ƒæ–™ï¼š<span id="fuel-num">0</span></div>
    </div>
    <div id="game-area">
      <div id="ship" class="ship">
        <img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.jpg">
      </div>
    </div>
  </div>

  <!-- æˆåŠŸ -->
  <div id="success" class="container hidden">
    <h1>æˆåŠŸé€šéå°è¡Œæ˜Ÿå¸¶ï¼</h1>
    <h4>å‰©é¤˜ <span id="fuel-final"></span> ç‡ƒæ–™</h4>
    <button onclick="location.href='intro2.html'">ç¹¼çºŒ</button>
  </div>

  <!-- å¤±æ•— -->
  <div id="fail" class="container hidden">
    <h1>å¤§å¤¢åˆé†’ï¼</h1>
    <h4>ä½ ç™¼å‘†äº†ä¸€ä¸‹<br>å»å½·å½¿çœ‹è¦‹å°è¡Œæ˜Ÿæ’ä¸Šå¤ªç©ºèˆ¹<br>ä½†ä½ æ²’ç©ºç†æœƒé€™å€‹å¹»è¦º<br>å¿…é ˆå°ˆæ³¨åœ¨çœ¼å‰ï¼Œé€šéå°è¡Œæ˜Ÿå¸¶ï¼</h4>
    <button onclick="restartGame()">å†æ¬¡æŒ‘æˆ°</button>
  </div>

  <script>
    const area = document.getElementById('game-area');
    const shipEl = document.getElementById('ship');
    const fuelEl = document.getElementById('fuel-num');

    let fuel = parseInt(localStorage.getItem("fuel") || "0");
    let fuelEarned  = 0;
    
    let items = [];
    
    let spawnTimer;
    let animId;
    let spawnDelay = 900;
    let bigMeteorSpawned = false;
    
    let playing = false;
    let shipTargetX = null;
    let shipAnimId = null;

    // å°éš•çŸ³å°ºå¯¸
    const smallTypes = [
      { val: 1,  size: 50 },
      { val: 5,  size: 70 },
      { val: 10, size: 90 }
    ];
    // å­å½ˆç³»çµ± ------------------------------------------- 
    let bullets = [];
    let fireInterval = 400;
    let fireTimer;
    let multiForward = 0;
    let multiDiagonal = 0;


    // åˆå§‹åŒ– ---------------------------------------------------------------- 
    window.addEventListener("DOMContentLoaded", () => { // ç•«é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
      document.getElementById("fuel").textContent = `å‰©é¤˜ ${fuel} ç‡ƒæ–™`;
    });

    // æ§åˆ¶é£›èˆ¹æ‹–æ›³
    area.addEventListener('pointerdown', moveShip);
    area.addEventListener('pointermove', e => playing && moveShip(e));

    function moveShip(e) {
      const rect = area.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      shipTargetX = x * 100;
      if (!shipAnimId) smoothMove();
    }

    function smoothMove() {
      if (shipTargetX === null) return;

      const currentLeft = parseFloat(shipEl.style.left || "0");
      const diff = shipTargetX - currentLeft;

      if (Math.abs(diff) < 0.5) {
        shipEl.style.left = shipTargetX + "%";
        shipAnimId = null;
        return;
      }

      shipEl.style.left = (currentLeft + diff * 0.15) + "%";
      shipAnimId = requestAnimationFrame(smoothMove);
    }

    

    // å­å½ˆç”Ÿæˆï¼ˆé€£ç™¼ã€å¤šç™¼ï¼‰
    function shoot() {
      spawnBullet(0, -12);
      if (multiForward) {
        spawnBullet(0, -12, -20);
      }
      if (multiDiagonal) {
        for (let i = 1; i <= multiDiagonal; i++) {
          spawnBullet(-6 * i, -12);
          spawnBullet(6 * i, -12);
        }
      }
    }

    function spawnBullet(offsetX, vy, extraY = 0) {
      const b = document.createElement('div');
      b.className = 'bullet';
      b.style.left = (shipEl.offsetLeft + shipEl.offsetWidth / 2 + offsetX) + 'px';
      b.style.top = (shipEl.offsetTop + extraY) + 'px';
      area.appendChild(b);
      bullets.push({ el: b, vy });
    }

    // å°éš•çŸ³ç”Ÿæˆ
    function spawnSmall() {
      const type = smallTypes[Math.floor(Math.random() * smallTypes.length)];
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.type = 'small';
      div.dataset.val = type.val;
      div.style.width = type.size + 'px';
      div.style.height = type.size + 'px';
      div.innerHTML = `<img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/asteroid.jpg">`;
      randomSpawn(div, 2 + Math.random() * 2);
    }

    // å¤§éš•çŸ³ç”Ÿæˆ
    function spawnBig() {
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.type = 'big';
      div.dataset.hp = 25;
      div.style.width = '160px';
      div.style.height = '160px';
      div.innerHTML = `<img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/asteroid.jpg">`;
      randomSpawn(div, 1.5);
    }

    // éš¨æ©Ÿä½ç½®ç”Ÿæˆ
    function randomSpawn(el, vy) {
      el.style.left = Math.random() * (area.offsetWidth - 100) + 'px';
      el.style.top = '-100px';
      area.appendChild(el);
      items.push({ el, vy });
    }

    // å¢ç›Šé“å…·åœ–ç‰‡
    const powerImgs = {
      rapid: "https://raw.githubusercontent.com/BonBonChou/Dora/main/images/continuous_arrow.jpg",
      forward: "https://raw.githubusercontent.com/BonBonChou/Dora/main/images/double_arrow.jpg",
      diag: "https://raw.githubusercontent.com/BonBonChou/Dora/main/images/inclined_arrow.jpg"
    };

    function spawnPower(x, y) {
      const chance = Math.random();
      let kind = chance < 0.33 ? 'rapid' : (chance < 0.66 ? 'forward' : 'diag');

      const p = document.createElement('div');
      p.className = 'power';
      p.dataset.type = 'power';
      p.dataset.kind = kind;
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      p.innerHTML = `<img src="${powerImgs[kind]}" style="width:100%; height:100%">`;
      area.appendChild(p);
      items.push({ el: p, vy: 2 });
    }

    // ä¸»éŠæˆ²è¿´åœˆ
    function loop() {
      // å­å½ˆç§»å‹•
      bullets.forEach(b => {
        b.el.style.top = (b.el.offsetTop - 10) + 'px';
      });

      bullets = bullets.filter(b => {
        if (b.el.offsetTop < -40) {
          b.el.remove();
          return false;
        }
        return true;
      });

      // éš•çŸ³èˆ‡é“å…·ç§»å‹•èˆ‡ç¢°æ’è™•ç†
      items.forEach(obj => {
        obj.el.style.top = (obj.el.offsetTop + obj.vy) + 'px';

        // æ’¿é“å…·
        if (obj.el.dataset.type === 'power' && hitTest(obj.el, shipEl)) {
          applyPower(obj.el.dataset.kind);
          obj.el.remove();
          obj.vy = 0;
        }

        // å¤ªç©ºèˆ¹æ’éš•çŸ³
        if ((obj.el.dataset.type === 'small' || obj.el.dataset.type === 'big') && hitTest(obj.el, shipEl)) {
          endFail();
        }

        // å­å½ˆæ’éš•çŸ³
        bullets.forEach(b => {
          if (hitTest(b.el, obj.el)) {
            if (obj.el.dataset.type === 'small') { // å°éš•çŸ³
              if (!bigMeteorSpawned) { // åªåœ¨å¤§éš•çŸ³æœªå‡ºç¾å‰åŠ ç‡ƒæ–™
                fuelEarned += parseInt(obj.el.dataset.val);

                fuel += parseInt(obj.el.dataset.val);
                fuelEl.textContent = fuel;
              }             

              if (Math.random() < 0.2) {
                spawnPower(obj.el.offsetLeft, obj.el.offsetTop);
              }

              obj.el.style.animation = 'explode .3s forwards';
              setTimeout(() => obj.el.remove(), 300);
              obj.vy = 9999; // ç§»é™¤æ§åˆ¶

            } else if (obj.el.dataset.type === 'big') { // å¤§éš•çŸ³
              let hp = --obj.el.dataset.hp;
              if (hp <= 0) {
                fuel += 100;
                fuelEl.textContent = fuel;
                obj.el.style.animation = 'explode .5s forwards';
                setTimeout(() => victory(), 500);
              }
            }

            b.el.remove();
            b.vy = 0;
          }
        });
      });
      /* æ¸…ç†è½å‡ºç•«é¢ */
      items = items.filter(o => {
        if (o.vy === 0) return false;
        if (o.el.offsetTop > area.offsetHeight + 120) {
          o.el.remove();
          return false;
        }
        return true;
      });

      if (playing) {
        animId = requestAnimationFrame(loop);
      }
    }

    // ç¢°æ’åˆ¤å®š
    function hitTest(a, b) {
      const ar = a.getBoundingClientRect();
      const br = b.getBoundingClientRect();
      return !(
        ar.right < br.left ||
        ar.left  > br.right ||
        ar.bottom < br.top ||
        ar.top > br.bottom
      );
    }

    // å¢ç›Šæ•ˆæœå¥—ç”¨
    function applyPower(kind) {
      if (kind === 'rapid') {
        fireInterval = Math.max(100, fireInterval - 80);
        clearInterval(fireTimer);
        fireTimer = setInterval(shoot, fireInterval);
      } else if (kind === 'forward') {
        multiForward = 1;
      } else if (kind === 'diag') {
        multiDiagonal = Math.min(2, multiDiagonal + 1);
      }
    }

    // ä¸»æµç¨‹æ§åˆ¶
    function startGame() {
      document.getElementById("tut").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      playing = true;
      fuelEarned = 0;
      fuelEl.textContent = fuel;

      fireTimer = setInterval(shoot, fireInterval);
      spawnTimer = setInterval(() => {
        if (!bigMeteorSpawned) {
          spawnSmall();
          spawnDelay = Math.max(200, spawnDelay - 15);
        }
      }, spawnDelay);

      animId = requestAnimationFrame(loop);
    }

    function checkBigMeteor() {
      if (fuel >= 500 && !bigMeteorSpawned) {
        bigMeteorSpawned = true;
        clearInterval(spawnTimer);
        spawnBig();
      }
    }

    function victory() {
      playing = false;
      clearInterval(spawnTimer);
      clearInterval(fireTimer);
      cancelAnimationFrame(animId);

      localStorage.setItem("fuel", fuel);
      document.getElementById("game").classList.add("hidden");
      document.getElementById("success").classList.remove("hidden");
      document.getElementById("fuel-final").textContent = fuel;
    }

    function endFail() {
      playing = false;
      clearInterval(spawnTimer);
      clearInterval(fireTimer);
      cancelAnimationFrame(animId);

      document.getElementById("game").classList.add("hidden");
      document.getElementById("fail").classList.remove("hidden");
    }

    // å¯é¸ï¼šå›é¦–é é‡æ–°æŒ‘æˆ°
    function restartGame() {
      document.getElementById("fail").classList.add("hidden");
      document.getElementById("tut").classList.remove("hidden");
      fuel = parseInt(localStorage.getItem("fuel") || "0");
      fuelEarned = 0;
      fireInterval = 400;
      multiForward = 0;
      multiDiagonal = 0;
      spawnDelay = 900;
      bigMeteorSpawned = false;
      bullets = [];
      items = [];

      clearInterval(fireTimer);
      clearInterval(spawnTimer);
      cancelAnimationFrame(animId);

      const area = document.getElementById("game-area");
      area.innerHTML = `
        <div id="ship" class="ship">
          <img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.png">
        </div>
      `;
      document.getElementById("game").classList.add("hidden");
    }

    // å¤§éš•çŸ³è§¸ç™¼æ¢ä»¶ç›£è½
    setInterval(() => {
      if (fuelEarned >= 500 && !bigMeteorSpawned) {
        bigMeteorSpawned = true;
        clearInterval(spawnTimer);  // åœç”¢å°éš•çŸ³
        spawnBig();
      }
    }, 400);

  </script>
</body>
</html>
