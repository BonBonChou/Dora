<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>小遊戲2</title>
  <style>
    body {
      margin: 0;
      background: transparent;
      font-family: 'Noto Sans TC', sans-serif;
      color: white;
      text-align: center;
    }

    .stars {
      position: fixed;
      width: 100%;
      height: 100%;
      background: url('https://raw.githubusercontent.com/BonBonChou/Dora/main/images/stars.jpeg') repeat-y center / cover;
      animation: scrollStars 60s linear infinite;
      z-index: 0;
      opacity: 0.8;
    }

    @keyframes scrollStars {
      from { background-position: 0 0; }
      to   { background-position: 0 1000px; }
    }

    .hidden {
      display: none;
    }

    button {
      margin: 1em;
      padding: 0.75em 2em;
      font-size: 1.2em;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #1e90ff;
      color: white;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #63b3ed;
    }

    .container {
      position: relative;
      z-index: 1;
      padding: 10vh 2em 2em;
      max-width: 650px;
      margin: auto;
    }

    h1 {
      font-size: 2.4em;
      margin: 0.2em 0;
    }

    h4 {
      font-size: 1.6em;
      color: #00ffcc;
      margin: 0 0 1em;
    }

    .intro {
      text-align: justify;
      background: rgba(255,255,255,0.05);
      padding: 1em;
      width: fit-content;     /* 核心：自動根據內容寬度調整 */
      max-width: 100%;        /* 防止太長時超出畫面 */
      border-radius: 10px;
      margin: 0 auto 1.5em auto;  /* 水平置中 */
      margin-bottom: 1.5em;
      font-size: 1em;
    }

    #game-area {
      position: relative;
      width: 100%;
      height: 80vh;
      overflow: hidden;
      cursor: pointer;
      z-index: 1;
    }

    .hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2em;
      font-size: 2.2em;
      z-index: 3;
    }

    .hud div {
      white-space: nowrap;
    }

    .ship {
      position: absolute;
      width: 80px;
      height: 80px;
      bottom: 10%;
      left: 25%;
      transform: translateX(-50%);
      transition: left 0.15s;
      z-index: 2;
    }

    .ship img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .bullet {
      position: absolute;
      width: 6px;
      height: 30px;
      background: #29dfff;
      pointer-events: none;
    }

    .item {
      position: absolute;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    .item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .m1  { background: #444; }
    .m5  { background: #555; }
    .m10 { background: #666; }
    .big {
      width: 160px;
      height: 160px;
      background: #784b1e;
    }

    .power {
      width: 60px;
      height: 60px;
      position: absolute;
      pointer-events: none;
    }

    @keyframes explode {
      to {
        transform: scale(1.5);
        opacity: 0;
      }
    }

    .fuel-status {
      font-weight: bold;
      color: #00ccff;
      margin-top: 0.5em;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <!-- 教學 -->
  <div id="tut" class="container">
    <h1>清除障礙物</h1>
    <h4>進入小行星帶，清除障礙物！</h4>
    <p id="fuel" class="fuel-status"></p>
    <div class="intro">
      <p>拖曳／點擊移動飛船，自動射擊粉碎隕石！</p>
      <p>🛢️ 擊碎不同隕石增加不同燃料（+1 / +5 / +10 / +100）</p>
      <p>💥 碰到隕石即失敗</p>
    </div>
    <button onclick="startGame()">開始遊戲</button>
  </div>

  <!-- 遊戲畫面 -->
  <div id="game" class="hidden">
    <div class="hud">
      <div>燃料：<span id="fuel-num">0</span></div>
    </div>
    <div id="game-area">
      <div id="ship" class="ship">
        <img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.jpg">
      </div>
    </div>
  </div>

  <!-- 成功 -->
  <div id="success" class="container hidden">
    <h1>成功通過小行星帶！</h1>
    <h4>剩餘 <span id="fuel-final"></span> 燃料</h4>
    <button onclick="location.href='intro2.html'">繼續</button>
  </div>

  <!-- 失敗 -->
  <div id="fail" class="container hidden">
    <h1>大夢初醒！</h1>
    <h4>你發呆了一下<br>卻彷彿看見小行星撞上太空船<br>但你沒空理會這個幻覺<br>必須專注在眼前，通過小行星帶！</h4>
    <button onclick="restartGame()">再次挑戰</button>
  </div>

  <script>
    const area = document.getElementById('game-area');
    const shipEl = document.getElementById('ship');
    const fuelEl = document.getElementById('fuel-num');

    let fuel = parseInt(localStorage.getItem("fuel") || "0");
    let fuelEarned  = 0;
    
    let items = [];
    
    let spawnTimer;
    let animId;
    let spawnDelay = 900;
    let bigMeteorSpawned = false;
    
    let playing = false;
    let shipTargetX = null;
    let shipAnimId = null;

    // 小隕石尺寸
    const smallTypes = [
      { val: 1,  size: 50 },
      { val: 5,  size: 70 },
      { val: 10, size: 90 }
    ];
    // 子彈系統 ------------------------------------------- 
    let bullets = [];
    let fireInterval = 400;
    let fireTimer;
    let multiForward = 0;
    let multiDiagonal = 0;


    // 初始化 ---------------------------------------------------------------- 
    window.addEventListener("DOMContentLoaded", () => { // 畫面載入完成後執行
      document.getElementById("fuel").textContent = `剩餘 ${fuel} 燃料`;
    });

    // 控制飛船拖曳
    area.addEventListener('pointerdown', moveShip);
    area.addEventListener('pointermove', e => playing && moveShip(e));

    function moveShip(e) {
      const rect = area.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      shipTargetX = x * 100;
      if (!shipAnimId) smoothMove();
    }

    function smoothMove() {
      if (shipTargetX === null) return;

      const currentLeft = parseFloat(shipEl.style.left || "0");
      const diff = shipTargetX - currentLeft;

      if (Math.abs(diff) < 0.5) {
        shipEl.style.left = shipTargetX + "%";
        shipAnimId = null;
        return;
      }

      shipEl.style.left = (currentLeft + diff * 0.15) + "%";
      shipAnimId = requestAnimationFrame(smoothMove);
    }

    

    // 子彈生成（連發、多發）
    function shoot() {
      spawnBullet(0, -12);
      if (multiForward) {
        spawnBullet(0, -12, -20);
      }
      if (multiDiagonal) {
        for (let i = 1; i <= multiDiagonal; i++) {
          spawnBullet(-6 * i, -12);
          spawnBullet(6 * i, -12);
        }
      }
    }

    function spawnBullet(offsetX, vy, extraY = 0) {
      const b = document.createElement('div');
      b.className = 'bullet';
      b.style.left = (shipEl.offsetLeft + shipEl.offsetWidth / 2 + offsetX) + 'px';
      b.style.top = (shipEl.offsetTop + extraY) + 'px';
      area.appendChild(b);
      bullets.push({ el: b, vy });
    }

    // 小隕石生成
    function spawnSmall() {
      const type = smallTypes[Math.floor(Math.random() * smallTypes.length)];
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.type = 'small';
      div.dataset.val = type.val;
      div.style.width = type.size + 'px';
      div.style.height = type.size + 'px';
      div.innerHTML = `<img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/asteroid.jpg">`;
      randomSpawn(div, 2 + Math.random() * 2);
    }

    // 大隕石生成
    function spawnBig() {
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.type = 'big';
      div.dataset.hp = 25;
      div.style.width = '160px';
      div.style.height = '160px';
      div.innerHTML = `<img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/asteroid.jpg">`;
      randomSpawn(div, 1.5);
    }

    // 隨機位置生成
    function randomSpawn(el, vy) {
      el.style.left = Math.random() * (area.offsetWidth - 100) + 'px';
      el.style.top = '-100px';
      area.appendChild(el);
      items.push({ el, vy });
    }

    // 增益道具圖片
    const powerImgs = {
      rapid: "https://raw.githubusercontent.com/BonBonChou/Dora/main/images/continuous_arrow.jpg",
      forward: "https://raw.githubusercontent.com/BonBonChou/Dora/main/images/double_arrow.jpg",
      diag: "https://raw.githubusercontent.com/BonBonChou/Dora/main/images/inclined_arrow.jpg"
    };

    function spawnPower(x, y) {
      const chance = Math.random();
      let kind = chance < 0.33 ? 'rapid' : (chance < 0.66 ? 'forward' : 'diag');

      const p = document.createElement('div');
      p.className = 'power';
      p.dataset.type = 'power';
      p.dataset.kind = kind;
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      p.innerHTML = `<img src="${powerImgs[kind]}" style="width:100%; height:100%">`;
      area.appendChild(p);
      items.push({ el: p, vy: 2 });
    }

    // 主遊戲迴圈
    function loop() {
      // 子彈移動
      bullets.forEach(b => {
        b.el.style.top = (b.el.offsetTop - 10) + 'px';
      });

      bullets = bullets.filter(b => {
        if (b.el.offsetTop < -40) {
          b.el.remove();
          return false;
        }
        return true;
      });

      // 隕石與道具移動與碰撞處理
      items.forEach(obj => {
        obj.el.style.top = (obj.el.offsetTop + obj.vy) + 'px';

        // 撿道具
        if (obj.el.dataset.type === 'power' && hitTest(obj.el, shipEl)) {
          applyPower(obj.el.dataset.kind);
          obj.el.remove();
          obj.vy = 0;
        }

        // 太空船撞隕石
        if ((obj.el.dataset.type === 'small' || obj.el.dataset.type === 'big') && hitTest(obj.el, shipEl)) {
          endFail();
        }

        // 子彈撞隕石
        bullets.forEach(b => {
          if (hitTest(b.el, obj.el)) {
            if (obj.el.dataset.type === 'small') { // 小隕石
              if (!bigMeteorSpawned) { // 只在大隕石未出現前加燃料
                fuelEarned += parseInt(obj.el.dataset.val);

                fuel += parseInt(obj.el.dataset.val);
                fuelEl.textContent = fuel;
              }             

              if (Math.random() < 0.2) {
                spawnPower(obj.el.offsetLeft, obj.el.offsetTop);
              }

              obj.el.style.animation = 'explode .3s forwards';
              setTimeout(() => obj.el.remove(), 300);
              obj.vy = 9999; // 移除控制

            } else if (obj.el.dataset.type === 'big') { // 大隕石
              let hp = --obj.el.dataset.hp;
              if (hp <= 0) {
                fuel += 100;
                fuelEl.textContent = fuel;
                obj.el.style.animation = 'explode .5s forwards';
                setTimeout(() => victory(), 500);
              }
            }

            b.el.remove();
            b.vy = 0;
          }
        });
      });
      /* 清理落出畫面 */
      items = items.filter(o => {
        if (o.vy === 0) return false;
        if (o.el.offsetTop > area.offsetHeight + 120) {
          o.el.remove();
          return false;
        }
        return true;
      });

      if (playing) {
        animId = requestAnimationFrame(loop);
      }
    }

    // 碰撞判定
    function hitTest(a, b) {
      const ar = a.getBoundingClientRect();
      const br = b.getBoundingClientRect();
      return !(
        ar.right < br.left ||
        ar.left  > br.right ||
        ar.bottom < br.top ||
        ar.top > br.bottom
      );
    }

    // 增益效果套用
    function applyPower(kind) {
      if (kind === 'rapid') {
        fireInterval = Math.max(100, fireInterval - 80);
        clearInterval(fireTimer);
        fireTimer = setInterval(shoot, fireInterval);
      } else if (kind === 'forward') {
        multiForward = 1;
      } else if (kind === 'diag') {
        multiDiagonal = Math.min(2, multiDiagonal + 1);
      }
    }

    // 主流程控制
    function startGame() {
      document.getElementById("tut").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      playing = true;
      fuelEarned = 0;
      fuelEl.textContent = fuel;

      fireTimer = setInterval(shoot, fireInterval);
      spawnTimer = setInterval(() => {
        if (!bigMeteorSpawned) {
          spawnSmall();
          spawnDelay = Math.max(200, spawnDelay - 15);
        }
      }, spawnDelay);

      animId = requestAnimationFrame(loop);
    }

    function checkBigMeteor() {
      if (fuel >= 500 && !bigMeteorSpawned) {
        bigMeteorSpawned = true;
        clearInterval(spawnTimer);
        spawnBig();
      }
    }

    function victory() {
      playing = false;
      clearInterval(spawnTimer);
      clearInterval(fireTimer);
      cancelAnimationFrame(animId);

      localStorage.setItem("fuel", fuel);
      document.getElementById("game").classList.add("hidden");
      document.getElementById("success").classList.remove("hidden");
      document.getElementById("fuel-final").textContent = fuel;
    }

    function endFail() {
      playing = false;
      clearInterval(spawnTimer);
      clearInterval(fireTimer);
      cancelAnimationFrame(animId);

      document.getElementById("game").classList.add("hidden");
      document.getElementById("fail").classList.remove("hidden");
    }

    // 可選：回首頁重新挑戰
    function restartGame() {
      document.getElementById("fail").classList.add("hidden");
      document.getElementById("tut").classList.remove("hidden");
      fuel = parseInt(localStorage.getItem("fuel") || "0");
      fuelEarned = 0;
      fireInterval = 400;
      multiForward = 0;
      multiDiagonal = 0;
      spawnDelay = 900;
      bigMeteorSpawned = false;
      bullets = [];
      items = [];

      clearInterval(fireTimer);
      clearInterval(spawnTimer);
      cancelAnimationFrame(animId);

      const area = document.getElementById("game-area");
      area.innerHTML = `
        <div id="ship" class="ship">
          <img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.png">
        </div>
      `;
      document.getElementById("game").classList.add("hidden");
    }

    // 大隕石觸發條件監聽
    setInterval(() => {
      if (fuelEarned >= 500 && !bigMeteorSpawned) {
        bigMeteorSpawned = true;
        clearInterval(spawnTimer);  // 停產小隕石
        spawnBig();
      }
    }, 400);

  </script>
</body>
</html>
