<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>小遊戲 4</title>

<style>
body{
  margin:0;
  background:transparent;
  font-family:'Noto Sans TC',sans-serif;
  color:#fff;
  text-align:center;
}
.stars{
  position:fixed;
  width:100%;height:100%;
  background:url('https://raw.githubusercontent.com/BonBonChou/Dora/main/images/stars.jpeg') repeat-y center/cover;
  animation:scrollStars 60s linear infinite;
  opacity:.8;z-index:0;
}
@keyframes scrollStars{
  from{background-position:0 0}to{background-position:0 1000px}
}
.hidden{display:none}

button {
  margin:1em;
  padding:.75em 2em;
  font-size:1.2em;
  border-radius:12px;
  border:none;
  cursor:pointer;
  background:#1e90ff;
  color:#fff;
  transition:background .3s;
}
button:hover {background:#63b3ed}
.container {
  position:relative;
  z-index:1;
  padding:10vh 2em 2em;
  max-width:650px;
  margin:auto;
}
h1 {
  font-size:2.3em;
  margin:.2em 0;
}
h4 {
  font-size:1.4em;
  color:#00ffcc;
  margin:0 0 1em
}

/* ===== 遊戲畫面 ===== */
#game-area {
  position:relative;
  width:100%;
  height:90vh;
  overflow:hidden;
  cursor:pointer;
  z-index:1;
}
.hud {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:2em;
  font-size:2em;
  z-index:3;
}
.hud div {white-space:nowrap}

/* 黑洞 & 飛船 */
.blackhole {
  position:absolute;
  left:50%;
  bottom:5%;
  transform:translate(-50%,-50%);
  width:200px;
  height:200px;
  border-radius:50%;
  overflow:hidden;
  pointer-events:none;
}
.blackhole img {
  width:100%;
  height:100%;
  object-fit:cover;
  animation:spin 4s linear infinite;
}
@keyframes spin {to{transform:rotate(360deg)}}
.ship {
  position:absolute;
  left:50%;
  top:40%;
  transform:translateX(-50%);
  width:80px;
  height:80px;
  pointer-events:none;
}
.ship img {
  width:100%;
  height:100%;
  object-fit:contain}

/* 進度條 */
#progress-wrapper {
  position:absolute;
  bottom:15%;
  left:50%;
  transform:translateX(-50%);
  width:70%;
  height:24px;
  border:2px solid #fff;
  border-radius:12px;
  overflow:hidden;
}
#progress-bar {
  width:0;
  height:100%;
  background:#29dfff;
  transition:width .05s linear;
}

/* 成功/失敗文字 */
.result-title {
  font-size:2em;
  margin-bottom:.5em;
  color:#00ffcc;
}

.fuel-status {
  font-weight: bold;
  color: #00ccff;
  margin-top: 0.5em;
  margin-bottom: 1em;
}
</style>
</head>
<body>
<div class="stars"></div>

<!-- 教學 -->
<div id="tut" class="container">
  <h1>快速逃離黑洞</h1>
  <h4>瘋狂點擊推進器！</h4>
  <p id="fuel" class="fuel-status"></p>
  <div class="intro">
    <p>每次 <strong>點擊 / 觸控</strong> 消耗 1 燃料並提升逃脫進度。</p>
    <p>進度條自動下降，填滿即成功，歸零即被黑洞吞噬！</p>
  </div>
  <button onclick="startGame()">開始遊戲</button>
</div>

<!-- 遊戲 -->
<div id="game" class="hidden">
  <div class="hud">
    <p id="fuel" class="fuel-status"></p>
  </div>
  <div id="game-area">
    <div class="blackhole"><img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/black_hole.jpg"></div>
    <div class="ship" id="ship"><img src="https://raw.githubusercontent.com/BonBonChou/Dora/main/images/ship.jpg"></div>

    <div id="progress-wrapper">
      <div id="progress-bar"></div>
    </div>
  </div>
</div>

<!-- 成功 -->
<div id="success" class="container hidden">
  <h1 class="result-title">成功脫離黑洞！</h1>
  <h4>剩餘 <span id="fuel-final"></span> 燃料</h4>
  <button onclick="location.href='intro4.html'">繼續航行</button>
</div>

<!-- 失敗 -->
<div id="fail" class="container hidden">
  <h1 class="result-title">墜入黑洞…</h1>
  <h4>再試一次，也許能逃出生天！</h4>
  <button onclick="restartGame()">重新挑戰</button>
</div>

<script>
/* ===== 變數 ===== */
const area      = document.getElementById('game-area');
const ship      = document.getElementById('ship');
const barWrap   = document.getElementById('progress-wrapper');
const bar       = document.getElementById('progress-bar');
const fuelHUD   = document.getElementById('fuel');

let fuel        = parseInt(localStorage.getItem('fuel') || '0');
let progress    = 0;         // 0~100
let playing     = false;
let lastTime    = 0;
const DECAY_RATE = 12;       // 每秒自動下降百分比
const GAIN_PER_CLICK = 5;    // 每點增加進度
let animId;

/* ===== 初始化 ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById("fuel").textContent = `剩餘 ${fuel} 燃料`;
});

/* ===== 主流程 ===== */
function startGame(){
  document.getElementById('tut').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');

  fuelHUD.textContent = fuel;
  progress = 25;
  updateBar();
  lastTime = performance.now();
  playing = true;

  area.addEventListener('pointerdown', clickHandler);
  animId = requestAnimationFrame(loop);
}

function clickHandler(){
  if (!playing) return;
  if (fuel <= 0) return;
  fuel--;
  fuelHUD.textContent = fuel;
  progress = Math.min(100, progress + GAIN_PER_CLICK);
  updateBar();
  moveShip();
}

/* ===== loop ===== */
function loop(now){
  const dt = (now - lastTime) / 1000;   // 秒
  lastTime = now;

  // 自動下降
  progress -= DECAY_RATE * dt;
  if (progress <= 0){
    progress = 0;
    fail();
    return;
  }
  updateBar();
  moveShip();

  animId = requestAnimationFrame(loop);
}

/* ===== UI 更新 ===== */
function updateBar(){
  bar.style.width = progress + '%';
  if (progress >= 100){
    success();
  }
}

function moveShip(){
  // 依進度往上移動一些（最大 40% 高度）
  const maxRaise = area.clientHeight * 0.4;
  ship.style.top = (5 + (100 - progress) / 100 * maxRaise / area.clientHeight * 100) + '%';
}

/* ===== 成功 / 失敗 ===== */
function success(){
  playing = false;
  localStorage.setItem('fuel', fuel);
  cancelAnimationFrame(animId);
  area.removeEventListener('pointerdown', clickHandler);

  document.getElementById('game').classList.add('hidden');
  document.getElementById('success').classList.remove('hidden');
  document.getElementById('fuel-final').textContent = fuel;
}

function fail(){
  playing = false;
  cancelAnimationFrame(animId);
  area.removeEventListener('pointerdown', clickHandler);

  document.getElementById('game').classList.add('hidden');
  document.getElementById('fail').classList.remove('hidden');
}

/* ===== 重新開始 ===== */
function restartGame(){
  document.getElementById('fail').classList.add('hidden');
  document.getElementById('tut').classList.remove('hidden');
}
</script>
</body>
</html>
